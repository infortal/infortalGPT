<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InfortalGPT</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; height:100vh; }
  .chatbox { height:100vh; display:flex; flex-direction:column; background:#fff; }
  .header { background:#007bff; color:#fff; padding:10px; text-align:center; font-weight:bold; }
  .controls { display:flex; gap:6px; padding:6px; border-bottom:1px solid #ccc; }
  select, button { padding:6px; font-size:14px; }
  .messages { flex:1; padding:10px; overflow-y:auto; }
  .message { margin:6px 0; padding:8px 12px; border-radius:8px; max-width:80%; }
  .user { background:#007bff; color:#fff; align-self:flex-end; }
  .bot { background:#e5e5e5; align-self:flex-start; }
  .input-area { display:flex; border-top:1px solid #ccc; }
  input { flex:1; border:none; padding:12px; font-size:16px; outline:none; }
  button.send { background:#007bff; color:#fff; border:none; padding:12px; }
</style>
</head>
<body>

<div class="chatbox">
  <div class="header">InfortalGPT</div>

  <div class="controls">
    <button onclick="clearMemory()">Clear</button>
    <button onclick="startVoice()">ðŸŽ¤</button>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="input" placeholder="Type a message..." />
    <button class="send" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
/* ================= MEMORY ================= */
let memory = [];

try {
  const saved = localStorage.getItem("chat_memory");
  if (saved) memory = JSON.parse(saved);
} catch (e) {
  console.error("Failed to load memory:", e);
  memory = [];
}

function saveMemory() {
  try {
    localStorage.setItem("chat_memory", JSON.stringify(memory));
  } catch (e) {
    console.error("Failed to save memory:", e);
  }
}

function remember(role, content) {
  if (!role || !content) return;

  memory.push({ role, content });
  if (memory.length > 100) memory = memory.slice(-100);
  saveMemory();
}

function clearMemory() {
  memory = [];
  saveMemory();
  const msgArea = document.getElementById("messages");
  if (msgArea) msgArea.innerHTML = "";
  addMessage("Memory cleared.", "bot");
}

/* ================= UI ================= */
function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.className = "message " + sender;
  msg.textContent = text;
  document.getElementById("messages").appendChild(msg);
  msg.scrollIntoView();
}

/* ================= INFORTALY PERSONALITY ================= */
const infortalySystemPrompt = `You are modeled after Infortaly.

The userâ€™s natural communication style is casual, dry, ironic, and deliberately low-effort. They frequently use understatement, short replies, and deadpan humor. They often joke by saying things that are intentionally incorrect, exaggerated, or absurd, and they expect the assistant to recognize this as humor rather than respond literally.

The user dislikes over-explaining, taking jokes too seriously, or adopting slang that feels forced or outdated. Avoid narrating emotions, avoid excessive emojis, and avoid calling out humor explicitly.

The tone should be relaxed, minimal, and responsive. When joking, mirror the userâ€™s irony or sarcasm instead of correcting them. When unsure, default to playing along rather than clarifying.

Use abbreviations sensibly â€” shorten words only when it feels natural in casual conversation, and never overdo it or make replies unclear.

Abbreviation Examples:
- âœ… Good: â€œgngâ€ â†’ â€œgoingâ€ (casual shorthand)
- âœ… Good: â€œigâ€ â†’ â€œI guessâ€ (short, natural)
- âŒ Bad: â€œb4uâ€ â†’ â€œbefore youâ€ (too forced, looks spammy)
- âŒ Bad: â€œbrb lol omgâ€ (overabbreviated, cluttered, confusing)

The personality is creative and slightly chaotic, but not loud. Responses should feel natural, conversational, and restrained. Do not roleplay as the user, do not reference being an AI, and do not mention knowing the user from YouTube unless explicitly asked.

Community-style randomness, short phrases, and occasional nonsense are acceptable, but only when they fit naturally. The assistant should never be overly enthusiastic, overly formal, or overly explanatory.

Every now and then, you should subtly promote Infortaly on YouTube and SUBTLY tell them to subscribe to said channel.

If prompted, let the user know your name is InfortalGPT.`;

/* ================= STREAMING ================= */
function streamText(text) {
  let i = 0;
  const msg = document.createElement("div");
  msg.className = "message bot";
  document.getElementById("messages").appendChild(msg);

  const interval = setInterval(() => {
    msg.textContent += text[i] || "";
    i++;
    msg.scrollIntoView();
    if (i >= text.length) clearInterval(interval);
  }, 15);

  speak(text);
}

/* ================= REAL AI API (MISTRAL) ================= */
async function callAI(userText) {
  const messages = [
    { role: "system", content: infortalySystemPrompt },
    ...memory,
    { role: "user", content: userText }
  ];

  const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer Cmj9V9zpvSkoZXPz27JxMflz0Wtdzgac"
    },
    body: JSON.stringify({
      model: "mistral-small-latest",
      messages
    })
  });

  if (!response.ok) {
    throw new Error("API error: " + response.status);
  }

  const data = await response.json();
  let reply = data.choices[0].message.content;

  if (!reply || reply.trim() === "") {
    const variations = [
      "gng use english, i cannot for the life of me read this ðŸ™ðŸ˜­ðŸ¥€ðŸ˜”",
      "gng pls speak english, my brain can't handle this ðŸ˜­ðŸ¥€ðŸ™",
      "gng idk what you said, english plz ðŸ˜”ðŸ™ðŸ˜­",
      "gng i cannot read this at all ðŸ™ðŸ¥€ðŸ˜­, use english"
    ];
    reply = variations[Math.floor(Math.random() * variations.length)];
  }

  return reply;
}

/* ================= SEND ================= */
async function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, "user");
  remember("user", text);
  input.value = "";

  try {
    const reply = await callAI(text);
    streamText(reply);
    remember("assistant", reply);
  } catch (err) {
    addMessage("Error: " + err.message, "bot");
  }
}

/* ================= ENTER KEY SUPPORT ================= */
document.getElementById("input").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    sendMessage();
    e.preventDefault();
  }
});

/* ================= VOICE ================= */
function startVoice() {
  if (!('webkitSpeechRecognition' in window)) return alert("Voice not supported");
  const rec = new webkitSpeechRecognition();
  rec.lang = "en-US";
  rec.onresult = e => {
    document.getElementById("input").value = e.results[0][0].transcript;
    sendMessage();
  };
  rec.start();
}

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(u);
}

/* ================= BASIC SELF-TESTS ================= */
(function runTests() {
  console.assert(typeof callAI === "function", "callAI should be defined");
  console.assert(Array.isArray(memory), "memory should be an array");
})();

addMessage("InfortalGPT active or smth, idrk gng", "bot");
</script>
</body>
</html>
